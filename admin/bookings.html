<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Bookings - Admin</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    @keyframes highlight-fade {
      0% { background-color: #fef3c7; }
      100% { background-color: transparent; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">SportCourt Admin</div>
    <div class="navbar-links">
      <a href="dashboard.html">Dashboard</a>
      <a href="courts.html">Manage Courts</a>
      <a href="bookings.html">Manage Bookings</a>
      <a href="scanner.html">QR Scanner</a>
      <a href="profile.html">Profile</a>
      
      <a href="#" onclick="logout()">Logout</a>
    </div>
  </nav>

  <div class="dashboard-container">
    <div class="dashboard-header">
      <h2>Manage Bookings</h2>
      <p>View and manage all court bookings</p>
    </div>

    <div class="card">
      <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
        <button onclick="filterBookings('all')" id="btnAll" class="success">All</button>
        <button onclick="filterBookings('booked')" id="btnBooked" class="secondary">Booked (Waiting)</button>
        <button onclick="filterBookings('confirmed')" id="btnConfirmed" class="secondary">Confirmed (Playing)</button>
        <button onclick="filterBookings('completed')" id="btnCompleted" class="secondary">Completed</button>
        <button onclick="filterBookings('cancelled')" id="btnCancelled" class="secondary">Cancelled</button>
      </div>

      <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
        <div style="flex: 1; min-width: 250px;">
          <input type="text" id="searchBooking" placeholder="Search by ID, court, user, or email..." onkeyup="filterBookings(currentFilter)" style="width: 100%;">
        </div>
        <div style="min-width: 200px;">
          <input type="date" id="dateFilter" onchange="filterBookings(currentFilter)" style="width: 100%;">
        </div>
        <button onclick="clearFilters()" class="secondary" style="white-space: nowrap;">Clear Filters</button>
      </div>
    </div>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0;">Bookings</h3>
        <span id="bookingCount" style="color: #64748b; font-size: 14px;"></span>
      </div>
      <div id="bookingsList"></div>
    </div>
  </div>

    <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-content">
      <!-- Brand Section -->
      <div class="footer-section footer-brand">
        <div class="footer-logo">
          <div class="footer-logo-mark"></div>
          <div class="footer-logo-text">SportCourt</div>
        </div>
        <p class="footer-description">
          Your premier destination for booking sports courts. Play anytime, anywhere with our seamless booking system.
        </p>
        <span class="footer-tagline">
          <span class="dot-live"></span>
          Book Smart, Play Hard
        </span>
      </div>

      <!-- Quick Links -->
      <div class="footer-section">
        <h3>Quick Links</h3>
        <div class="footer-links">
          <a href="dashboard.html" class="footer-link">Dashboard</a>
          <a href="courts.html" class="footer-link">Browse Courts</a>
          <a href="bookings.html" class="footer-link">My Bookings</a>
          <a href="favorites.html" class="footer-link">Favorites</a>
          <a href="profile.html" class="footer-link">Profile</a>
        </div>
      </div>

      <!-- Resources -->
      <div class="footer-section">
        <h3>Resources</h3>
        <div class="footer-links">
          <a href="#" class="footer-link">FAQs</a>
          <a href="#" class="footer-link">How It Works</a>
          <a href="#" class="footer-link">Pricing</a>
          <a href="#" class="footer-link">Safety Guidelines</a>
          <a href="#" class="footer-link">Court Rules</a>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="footer-section">
        <h3>Contact Us</h3>
        <div class="footer-contact-info">
          <div class="contact-item">
            <div class="contact-icon"></div>
            <div class="contact-details">
              <span class="contact-label">Email</span>
              <span class="contact-value">
                <a href="mailto:john@test.com">john@test.com</a>
              </span>
            </div>
          </div>
          
          <div class="contact-item">
            <div class="contact-icon"></div>
            <div class="contact-details">
              <span class="contact-label">Phone</span>
              <span class="contact-value">
                <a href="tel:+91234565">+91234565</a>
              </span>
            </div>
          </div>
          
          <div class="contact-item">
            <div class="contact-icon"></div>
            <div class="contact-details">
              <span class="contact-label">Support</span>
              <span class="contact-value">Customer Service</span>
            </div>
          </div>
        </div>

        <!-- Social Media Links -->
        <div class="footer-social">
          <a href="#" class="social-link" title="Facebook"></a>
          <a href="#" class="social-link" title="Twitter"></a>
          <a href="#" class="social-link" title="Instagram"></a>
          <a href="#" class="social-link" title="LinkedIn"></a>
        </div>
      </div>
    </div>

    <!-- Footer Bottom -->
    <div class="footer-bottom">
      <div class="footer-copyright">
        © 2024 SportCourt. All rights reserved. Made with <span class="heart"></span>
      </div>
      <div class="footer-legal">
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Service</a>
        <a href="#">Refund Policy</a>
        <a href="#">Accessibility</a>
      </div>
    </div>
  </footer>

  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    checkAdminAuth();
    let allBookings = [];
    let currentFilter = 'all';

    // Utility functions for formatting
    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return 'Invalid Date';
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }

    function formatTime(timeStr) {
      if (!timeStr) return 'N/A';
      // Handle both full datetime and time-only strings
      const timePart = timeStr.includes('T') ? timeStr.split('T')[1] : timeStr;
      const [hours, minutes] = timePart.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour % 12 || 12;
      return `${displayHour}:${minutes} ${ampm}`;
    }

    function isToday(dateStr) {
      if (!dateStr) return false;
      // Strip any time portion, keep only YYYY-MM-DD
      const datePart = dateStr.split('T')[0];
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      return datePart === `${yyyy}-${mm}-${dd}`;
    }

    async function loadBookings() {
      try {
        // Add timestamp to prevent caching
        const timestamp = new Date().getTime();
        allBookings = await apiFetch(`/admin/bookings?_t=${timestamp}`, {
          headers: authHeader()
        });
        console.log('Loaded bookings:', allBookings.length);
      } catch(err) {
        console.error("Error loading bookings:", err);
      }
    }

    function filterBookings(filter) {
      currentFilter = filter;
      document.querySelectorAll('[id^="btn"]').forEach(b => b.className = 'secondary');
      
      // Handle the button highlighting
      const btnId = `btn${filter.charAt(0).toUpperCase() + filter.slice(1)}`;
      const btn = document.getElementById(btnId);
      if (btn) btn.className = 'success';

      const search = document.getElementById("searchBooking").value.toLowerCase();
      const dateFilter = document.getElementById("dateFilter").value;
      let filtered = allBookings;

      // Filter by status
      if (filter !== 'all') {
        filtered = filtered.filter(b => b.status === filter);
      }

      // Filter by date (exact match)
      if (dateFilter) {
        filtered = filtered.filter(b => {
          // Normalize both dates to YYYY-MM-DD format for comparison
          const bookingDate = b.date ? b.date.split('T')[0] : '';
          return bookingDate === dateFilter;
        });
      }

      // Filter by search text (ID, court name, email, or partial date)
      if (search) {
        filtered = filtered.filter(b => {
          const idMatch = b.id && b.id.toString().includes(search);
          const courtMatch = b.court_name && b.court_name.toLowerCase().includes(search);
          const emailMatch = b.email && b.email.toLowerCase().includes(search);
          // Normalize date for search (handle both YYYY-MM-DD and datetime formats)
          const normalizedDate = b.date ? b.date.split('T')[0] : '';
          const dateMatch = normalizedDate.includes(search);
          
          return idMatch || courtMatch || emailMatch || dateMatch;
        });
      }

      displayBookings(filtered);
    }

    function clearFilters() {
      document.getElementById("searchBooking").value = '';
      document.getElementById("dateFilter").value = '';
      filterBookings('all');
    }

    function displayBookings(bookings) {
      const container = document.getElementById("bookingsList");
      const countElement = document.getElementById("bookingCount");

      // Update count
      countElement.textContent = `Showing ${bookings.length} booking${bookings.length !== 1 ? 's' : ''}`;

      if (bookings.length === 0) {
        container.innerHTML = '<p>No bookings found.</p>';
        return;
      }

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Court</th>
              <th>User</th>
              <th>Date</th>
              <th>Time</th>
              <th>Status</th>
              <th>Cost</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${bookings.map(b => `
              <tr ${b.id === lastUpdatedId ? 'style="background-color: #fef3c7; animation: highlight-fade 2s ease-out;"' : ''}>
                <td>#${b.id}</td>
                <td>${b.court_name || 'N/A'}</td>
                <td>${b.email || 'N/A'}</td>
                <td>${formatDate(b.date)}</td>
                <td>${formatTime(b.start_time)} - ${formatTime(b.end_time)}</td>
                <td><span style="color: ${getStatusColor(b.status)}; font-weight: bold;">${b.status.replace('_', ' ').toUpperCase()}</span></td>
                <td>${b.total_price || 0} coins</td>
                <td>
                  ${getActionButtons(b)}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      // Clear the lastUpdatedId after a delay
      if (lastUpdatedId) {
        setTimeout(() => { lastUpdatedId = null; }, 3000);
      }
    }

    function getActionButtons(booking) {
      const buttons = [];
      
      // For BOOKED status → Check in + Cancel
      if (booking.status === 'booked') {
        buttons.push(`<button onclick="confirmBooking(${booking.id})" class="success" style="padding: 5px 10px; width: auto; margin: 2px;">✓ Check in</button>`);
        buttons.push(`<button onclick="cancelBooking(${booking.id})" class="danger" style="padding: 5px 10px; width: auto; margin: 2px;">✗ Cancel</button>`);
      }
      
      // For CONFIRMED status → Check out (user is currently playing)
      if (booking.status === 'confirmed') {
        // Check if potentially late
        const now = new Date();
        const bookingEnd = new Date(`${booking.date} ${booking.end_time}`);
        const gracePeriodEnd = new Date(bookingEnd.getTime() + 15 * 60000); // +15 minutes
        const isLate = now > gracePeriodEnd;
        
        const checkoutBtnClass = isLate ? 'danger' : 'primary';
        const checkoutText = isLate ? '⚠️ Check out (LATE)' : '✓ Check out';
        
        buttons.push(`<button onclick="checkOutBooking(${booking.id}, ${isLate})" class="${checkoutBtnClass}" style="padding: 5px 10px; width: auto; margin: 2px;">${checkoutText}</button>`);
      }

      // COMPLETED, CANCELLED = No actions
      return buttons.length > 0 ? buttons.join('') : '-';
    }

    function getStatusColor(status) {
      const colors = {
        booked: '#f59e0b',      // orange - waiting for check-in
        confirmed: '#16a34a',   // green - currently playing
        completed: '#2563eb',   // blue - finished
        cancelled: '#dc2626'    // red - cancelled
      };
      return colors[status] || '#64748b';
    }

    let lastUpdatedId = null;

    async function confirmBooking(id) {
      if (!confirm('Confirm this booking? This means the user has checked in.')) return;

      try {
        console.log('Confirming booking ID:', id);
        const response = await apiFetch(`/admin/bookings/${id}/confirm`, {
          method: "POST",
          headers: authHeader()
        });
        console.log('Confirm response:', response);
        
        lastUpdatedId = id;
        showAlert('✅ Booking confirmed! Status changed to CONFIRMED. User has been notified.', 'success');
        
        // Small delay to ensure database commit
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Reload bookings data
        console.log('Loading fresh bookings...');
        await loadBookings();
        console.log('Bookings loaded, count:', allBookings.length);
        console.log('Looking for booking', id, 'in fresh data:', allBookings.find(b => b.id === id));
        
        // Switch to 'all' view so user can see the confirmed booking
        filterBookings('all');
      } catch(err) {
        console.error('Confirm error:', err);
        showAlert(err.message || 'Confirmation failed', 'error');
      }
    }

    async function cancelBooking(id) {
      if (!confirm('Cancel this booking? User will receive full refund and notification.')) return;

      try {
        const response = await apiFetch(`/admin/bookings/${id}`, {
          method: "DELETE",
          headers: authHeader()
        });
        
        const refundMsg = response.refunded_amount 
          ? ` ${response.refunded_amount} coins have been refunded.`
          : '';
        
        lastUpdatedId = id;
        showAlert(`✅ Booking cancelled. User notified and refunded.${refundMsg}`, 'success');
        
        // Small delay to ensure database commit
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Reload bookings data
        await loadBookings();
        
        // Switch to 'all' view so user can see the cancelled booking
        filterBookings('all');
      } catch(err) {
        showAlert(err.message || 'Cancellation failed', 'error');
      }
    }

    // Check out function
    async function checkOutBooking(id, isLate) {
      const booking = allBookings.find(b => b.id === id);
      if (!booking) return;
      
      let confirmMessage = 'Check out this booking?';
      
      if (isLate) {
        const now = new Date();
        const bookingEnd = new Date(`${booking.date} ${booking.end_time}`);
        const gracePeriodEnd = new Date(bookingEnd.getTime() + 15 * 60000);
        const minutesLate = Math.floor((now - gracePeriodEnd) / 60000);
        
        confirmMessage = `⚠️ WARNING: User is ${minutesLate} minutes late!\n\n`;
        confirmMessage += 'A 50 coin penalty will be applied.\n\n';
        confirmMessage += 'Proceed with checkout?';
      }
      
      if (!confirm(confirmMessage)) return;

      try {
        console.log('Checking out booking ID:', id);
        const response = await apiFetch(`/bookings/checkout/${id}`, {
          method: "POST",
          headers: authHeader()
        });
        console.log('Checkout response:', response);
        
        lastUpdatedId = id;
        
        if (isLate) {
          showAlert('✅ Booking checked out. 50 coin late penalty applied to user.', 'warning');
        } else {
          showAlert('✅ Booking checked out successfully!', 'success');
        }
        
        // Small delay to ensure database commit
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Reload bookings data
        console.log('Loading fresh bookings...');
        await loadBookings();
        console.log('Bookings loaded, count:', allBookings.length);
        
        // Refresh current view
        filterBookings(currentFilter);
      } catch(err) {
        console.error('Checkout error:', err);
        showAlert(err.message || 'Checkout failed', 'error');
      }
    }

    async function init() {
      await loadBookings();
      filterBookings('all');
    }
    
    init();
  </script>
</body>
</html>