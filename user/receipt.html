<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receipt - Sport Court Booking</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .receipt-container {
      max-width: 800px;
      margin: 30px auto;
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .receipt-header {
      text-align: center;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    
    .receipt-header h1 {
      margin: 0 0 10px 0;
      color: #6366f1;
    }
    
    .receipt-header h2 {
      margin: 0 0 10px 0;
      color: #333;
    }
    
    .receipt-details {
      margin-bottom: 30px;
    }
    
    .receipt-details h3 {
      color: #6366f1;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .receipt-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .receipt-row span:first-child {
      color: #666;
    }
    
    .receipt-row span:last-child {
      font-weight: 600;
      color: #333;
    }
    
    .receipt-total {
      background: #f9fafb;
      padding: 15px !important;
      margin-top: 10px;
      border-radius: 8px;
      border: 2px solid #6366f1 !important;
    }
    
    .receipt-total span {
      font-size: 1.2em;
      color: #6366f1 !important;
      font-weight: bold !important;
    }
    
    .receipt-qr {
      text-align: center;
      padding: 30px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    
    .receipt-qr h3 {
      color: #6366f1;
      margin-bottom: 20px;
    }
    
    #qrCode {
      display: inline-block;
      padding: 20px;
      background: white;
      border-radius: 8px;
    }
    
    .button-group {
      text-align: center;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 1em;
      transition: all 0.2s;
    }
    
    .btn-success {
      background: #22c55e;
      color: white;
    }
    
    .btn-success:hover {
      background: #16a34a;
    }
    
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }
    
    .btn-secondary:hover {
      background: #d1d5db;
    }
    
    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }
    
    @media print {
      .btn, nav, .button-group {
        display: none !important;
      }
      
      body {
        background: white;
      }
      
      .receipt-container {
        box-shadow: none;
        max-width: 100%;
        margin: 0;
        padding: 20px;
      }
      
      .receipt-header {
        background: #6366f1;
        color: white;
        padding: 30px;
        margin: -20px -20px 20px -20px;
        border-radius: 0;
      }
      
      .receipt-header h1, .receipt-header h2, .receipt-header p {
        color: white;
      }
      
      .receipt-qr {
        page-break-inside: avoid;
        border: 2px solid #6366f1;
        padding: 20px;
      }
      
      .receipt-details {
        page-break-inside: avoid;
      }
      
      /* Ensure QR code prints clearly */
      #qrCode canvas {
        max-width: 200px !important;
        height: auto !important;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">üèüÔ∏è SportCourt</div>
    <div class="navbar-links">
      <a href="dashboard.html">Dashboard</a>
      <a href="bookings.html">My Bookings</a>
    </div>
  </nav>

  <div class="dashboard-container">
    <div class="receipt-container">
      <div class="receipt-header">
        <h1>üèüÔ∏è SportCourt</h1>
        <h2>Booking Confirmation Receipt</h2>
        <p>Receipt #<span id="receiptId"></span></p>
      </div>

      <div id="errorContainer"></div>
      <div id="receiptContent" style="display: none;">
        <div class="receipt-details">
          <h3>Booking Details</h3>
          <div class="receipt-row">
            <span>Court:</span>
            <span id="courtName"></span>
          </div>
          <div class="receipt-row">
            <span>Date:</span>
            <span id="bookingDate"></span>
          </div>
          <div class="receipt-row">
            <span>Time:</span>
            <span id="bookingTime"></span>
          </div>
          <div class="receipt-row">
            <span>Status:</span>
            <span id="status" style="font-weight: bold; color: #16a34a;"></span>
          </div>
        </div>

        <div class="receipt-details">
          <h3>Payment Summary</h3>
          <div class="receipt-row">
            <span>Court Rental:</span>
            <span id="courtCost"></span>
          </div>
          <div id="servicesSection"></div>
          <div class="receipt-row receipt-total">
            <span>Total Paid:</span>
            <span id="totalCost"></span>
          </div>
        </div>

        <div class="receipt-qr">
          <h3>Check-in QR Code</h3>
          <div id="qrCode"></div>
          <p>Show this QR code at the court for check-in</p>
        </div>

        <div class="receipt-details">
          <h3>Important: Penalties & Rules</h3>
          <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <ol style="margin: 0; padding-left: 20px; color: #78350f;">
              <li style="margin-bottom: 12px;">
                <strong>Misconduct or Fighting</strong><br>
                <span style="font-size: 0.95em; color: #92400e;">Any form of fighting, violence, or serious misconduct will result in a six-months suspension from using the booking system and facilities.</span>
              </li>
              <li style="margin-bottom: 12px;">
                <strong>Overstaying Beyond the Booked Time</strong><br>
                <span style="font-size: 0.95em; color: #92400e;">If users continue to use the court after their booked time has ended, they will be suspended for one month and will also be required to pay the full court fee for the following month.</span>
              </li>
              <li>
                <strong>Damage to Court Property</strong><br>
                <span style="font-size: 0.95em; color: #92400e;">Any damage caused to court property or equipment must be compensated at ten (10) times the actual cost of the damage.</span>
              </li>
            </ol>
          </div>
        </div>

        <div class="button-group">
          <button onclick="downloadPDF()" class="btn btn-success">Download PDF</button>
          <button onclick="window.print()" class="btn btn-secondary">Print Receipt</button>
          <button onclick="location.href='bookings.html'" class="btn btn-secondary">Back to Bookings</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/api.js"></script>
  <script src="../js/auth.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    checkAuth();

    // Format date helper
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }

    // Format time helper
    function formatTime(timeString) {
      if (!timeString) return '';
      const [hours, minutes] = timeString.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour % 12 || 12;
      return `${displayHour}:${minutes} ${ampm}`;
    }

    // Show error
    function showError(message) {
      document.getElementById('errorContainer').innerHTML = `
        <div class="error-message">${message}</div>
      `;
      document.getElementById('receiptContent').style.display = 'none';
    }

    async function loadReceipt() {
      const bookingId = localStorage.getItem('bookingId');
      
      if (!bookingId) {
        showError('No booking ID found. Please select a booking from your bookings page.');
        setTimeout(() => location.href = 'bookings.html', 3000);
        return;
      }

      try {
        console.log('Loading receipt for booking ID:', bookingId);
        
        // Fetch all bookings
        const bookings = await apiFetch("/bookings/my-bookings", {
          headers: authHeader()
        });
        
        console.log('All bookings:', bookings);
        
        // Find the specific booking
        const booking = bookings.find(b => b.id == bookingId);
        
        if (!booking) {
          showError('Booking not found. This booking may have been cancelled or does not exist.');
          setTimeout(() => location.href = 'bookings.html', 3000);
          return;
        }

        console.log('Found booking:', booking);

        // Populate receipt - using correct field names from database
        document.getElementById("receiptId").textContent = booking.id;
        document.getElementById("courtName").textContent = booking.court_name || `Court ${booking.court_id}`;
        document.getElementById("bookingDate").textContent = formatDate(booking.date); // Using 'date' field
        document.getElementById("bookingTime").textContent = 
          `${formatTime(booking.start_time)} - ${formatTime(booking.end_time)}`;
        document.getElementById("status").textContent = booking.status.toUpperCase();
        
        // Using 'total_price' field from database
        const totalAmount = booking.total_price || 0;
        document.getElementById("courtCost").textContent = totalAmount + ' coins';
        document.getElementById("totalCost").textContent = totalAmount + ' coins';

        // Services
        if (booking.services) {
          try {
            const services = typeof booking.services === 'string' ? 
              JSON.parse(booking.services) : booking.services;
            let servicesHTML = '';
            if (services.water) servicesHTML += '<div class="receipt-row"><span>Water Bottles:</span><span>20 coins</span></div>';
            if (services.referee) servicesHTML += '<div class="receipt-row"><span>Referee Service:</span><span>100 coins</span></div>';
            if (services.accommodation) servicesHTML += '<div class="receipt-row"><span>Fan Accommodation:</span><span>150 coins</span></div>';
            document.getElementById("servicesSection").innerHTML = servicesHTML;
          } catch (e) {
            console.error('Error parsing services:', e);
          }
        }

        // Generate QR Code
        const qrData = booking.qr_code || `BOOKING:${booking.id}:${booking.court_name || booking.court_id}:${booking.date}`;
        new QRCode(document.getElementById("qrCode"), {
          text: qrData,
          width: 200,
          height: 200
        });

        // Show the receipt
        document.getElementById('receiptContent').style.display = 'block';

      } catch(err) {
        console.error("Error loading receipt:", err);
        showError('Error loading receipt: ' + (err.message || 'Unknown error'));
      }
    }

    async function downloadPDF() {
      // Show loading message
      const loadingMsg = document.createElement('div');
      loadingMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#6366f1;color:white;padding:15px 20px;border-radius:8px;z-index:9999;box-shadow:0 4px 6px rgba(0,0,0,0.1);';
      loadingMsg.textContent = '‚è≥ Generating PDF...';
      document.body.appendChild(loadingMsg);

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Colors
        const primaryColor = [99, 102, 241]; // #6366f1
        const darkColor = [31, 41, 55]; // #1f2937
        const lightGray = [243, 244, 246]; // #f3f4f6
        const textGray = [107, 114, 128]; // #6b7280
        
        // Get booking data
        const receiptId = document.getElementById("receiptId").textContent;
        const courtName = document.getElementById("courtName").textContent;
        const bookingDate = document.getElementById("bookingDate").textContent;
        const bookingTime = document.getElementById("bookingTime").textContent;
        const status = document.getElementById("status").textContent;
        const courtCost = document.getElementById("courtCost").textContent;
        const totalCost = document.getElementById("totalCost").textContent;
        
        // Header with colored background
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, 210, 45, 'F');
        
        // Logo emoji and title
        doc.setFontSize(28);
        doc.setTextColor(255, 255, 255);
        doc.text('üèüÔ∏è SportCourt', 105, 20, { align: 'center' });
        
        doc.setFontSize(16);
        doc.text('Booking Confirmation Receipt', 105, 30, { align: 'center' });
        
        doc.setFontSize(11);
        doc.text(`Receipt #${receiptId}`, 105, 38, { align: 'center' });
        
        // Date stamp
        doc.setFontSize(9);
        doc.setTextColor(...textGray);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 50, { align: 'center' });
        
        // Booking Details Section
        let yPos = 65;
        doc.setFillColor(...lightGray);
        doc.roundedRect(15, yPos - 5, 180, 10, 2, 2, 'F');
        doc.setFontSize(14);
        doc.setTextColor(...primaryColor);
        doc.setFont(undefined, 'bold');
        doc.text('Booking Details', 20, yPos);
        
        yPos += 12;
        doc.setFontSize(11);
        doc.setTextColor(...darkColor);
        doc.setFont(undefined, 'normal');
        
        // Court
        doc.setFont(undefined, 'bold');
        doc.text('Court:', 20, yPos);
        doc.setFont(undefined, 'normal');
        doc.text(courtName, 80, yPos);
        
        yPos += 8;
        doc.setFont(undefined, 'bold');
        doc.text('Date:', 20, yPos);
        doc.setFont(undefined, 'normal');
        doc.text(bookingDate, 80, yPos);
        
        yPos += 8;
        doc.setFont(undefined, 'bold');
        doc.text('Time:', 20, yPos);
        doc.setFont(undefined, 'normal');
        doc.text(bookingTime, 80, yPos);
        
        yPos += 8;
        doc.setFont(undefined, 'bold');
        doc.text('Status:', 20, yPos);
        doc.setTextColor(34, 197, 94); // Green for status
        doc.setFont(undefined, 'bold');
        doc.text(status, 80, yPos);
        
        // Payment Summary Section
        yPos += 18;
        doc.setFillColor(...lightGray);
        doc.roundedRect(15, yPos - 5, 180, 10, 2, 2, 'F');
        doc.setFontSize(14);
        doc.setTextColor(...primaryColor);
        doc.setFont(undefined, 'bold');
        doc.text('Payment Summary', 20, yPos);
        
        yPos += 12;
        doc.setFontSize(11);
        doc.setTextColor(...darkColor);
        doc.setFont(undefined, 'normal');
        
        doc.setFont(undefined, 'bold');
        doc.text('Court Rental:', 20, yPos);
        doc.setFont(undefined, 'normal');
        doc.text(courtCost, 170, yPos, { align: 'right' });
        
        // Total box
        yPos += 10;
        doc.setFillColor(239, 246, 255); // Light blue
        doc.setDrawColor(...primaryColor);
        doc.setLineWidth(0.5);
        doc.roundedRect(15, yPos - 5, 180, 12, 2, 2, 'FD');
        
        doc.setFontSize(13);
        doc.setTextColor(...primaryColor);
        doc.setFont(undefined, 'bold');
        doc.text('Total Paid:', 20, yPos + 3);
        doc.text(totalCost, 175, yPos + 3, { align: 'right' });
        
        // QR Code Section
        yPos += 20;
        doc.setFillColor(...lightGray);
        doc.roundedRect(15, yPos - 5, 180, 10, 2, 2, 'F');
        doc.setFontSize(14);
        doc.setTextColor(...primaryColor);
        doc.text('Check-in QR Code', 20, yPos);
        
        // Capture QR code
        const qrElement = document.getElementById('qrCode');
        const canvas = await html2canvas(qrElement, {
          backgroundColor: '#ffffff',
          scale: 2
        });
        
        const qrImgData = canvas.toDataURL('image/png');
        
        // Add QR code to PDF (centered)
        yPos += 5;
        const qrSize = 50;
        doc.addImage(qrImgData, 'PNG', (210 - qrSize) / 2, yPos, qrSize, qrSize);
        
        yPos += qrSize + 5;
        doc.setFontSize(9);
        doc.setTextColor(...textGray);
        doc.text('Show this QR code at the court for check-in', 105, yPos, { align: 'center' });
        
        // Rules Section
        yPos += 10;
        doc.setFillColor(...lightGray);
        doc.roundedRect(15, yPos - 5, 180, 10, 2, 2, 'F');
        doc.setFontSize(14);
        doc.setTextColor(...primaryColor);
        doc.setFont(undefined, 'bold');
        doc.text('Important: Penalties & Rules', 20, yPos);
        
        yPos += 10;
        doc.setFillColor(254, 243, 199); // Yellow background
        doc.setDrawColor(245, 158, 11); // Orange border
        doc.setLineWidth(1);
        doc.roundedRect(15, yPos - 5, 180, 50, 2, 2, 'FD');
        
        yPos += 2;
        doc.setFontSize(10);
        doc.setTextColor(...darkColor);
        
        // Rule 1
        doc.setFont(undefined, 'bold');
        doc.text('1. Misconduct or Fighting', 20, yPos);
        yPos += 5;
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        const rule1Text = 'Any form of fighting, violence, or serious misconduct will result in a six-months suspension.';
        const rule1Lines = doc.splitTextToSize(rule1Text, 170);
        doc.text(rule1Lines, 20, yPos);
        yPos += (rule1Lines.length * 4) + 3;
        
        // Rule 2
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('2. Overstaying Beyond the Booked Time', 20, yPos);
        yPos += 5;
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        const rule2Text = 'Continuing to use the court after your booked time results in one month suspension and full payment for the following month.';
        const rule2Lines = doc.splitTextToSize(rule2Text, 170);
        doc.text(rule2Lines, 20, yPos);
        yPos += (rule2Lines.length * 4) + 3;
        
        // Rule 3
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('3. Damage to Court Property', 20, yPos);
        yPos += 5;
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        const rule3Text = 'Any damage must be compensated at ten (10) times the actual cost of the damage.';
        const rule3Lines = doc.splitTextToSize(rule3Text, 170);
        doc.text(rule3Lines, 20, yPos);
        
        // Footer
        doc.setFontSize(8);
        doc.setTextColor(...textGray);
        doc.text('Thank you for choosing SportCourt! Enjoy your game!', 105, 285, { align: 'center' });
        doc.text('For support, contact: support@sportcourt.com', 105, 290, { align: 'center' });
        
        // Save the PDF
        doc.save(`receipt-${receiptId}.pdf`);
        
        // Remove loading and show success
        loadingMsg.remove();
        const successMsg = document.createElement('div');
        successMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#22c55e;color:white;padding:15px 20px;border-radius:8px;z-index:9999;box-shadow:0 4px 6px rgba(0,0,0,0.1);';
        successMsg.textContent = '‚úì PDF downloaded successfully!';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
        
      } catch (error) {
        console.error('PDF generation error:', error);
        loadingMsg.remove();
        const errorMsg = document.createElement('div');
        errorMsg.style.cssText = 'position:fixed;top:20px;right:20px;background:#ef4444;color:white;padding:15px 20px;border-radius:8px;z-index:9999;box-shadow:0 4px 6px rgba(0,0,0,0.1);';
        errorMsg.textContent = '‚úó PDF generation failed!';
        document.body.appendChild(errorMsg);
        setTimeout(() => errorMsg.remove(), 3000);
      }
    }

    // Load receipt on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadReceipt();
    });
  </script>
</body>
</html>